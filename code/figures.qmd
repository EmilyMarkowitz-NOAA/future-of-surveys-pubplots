---
title: "Publication Plots"
editor: source
author:
    - name: Emily Markowitz
      email: Emily.Markowitz@noaa.gov 
      note: https://github.com/afsc-gap-products
      affiliations:
        - name: NOAA Fisheres Alaska Fisheries Science Center
          department: Groundfish Assessment Program, Bering Sea Survey Team
    - name: Catherine Foley
      email: Catherine.Foley@noaa.gov 
      note: https://github.com/noaa-nefsc
      affiliations:
        - name: NOAA Fisheres Northeast Fisheries Science Center
          department: Groundfish Assessment Program
date: "`r paste0(format(Sys.time(), '%B %d, %Y'))`"
format: html
toc-location: body
toc-depth: 3
---

Search query: https://www.webofscience.com/wos/woscc/summary/7f060455-0bd6-4643-bd2f-2de3ceedb0b2-f52da389/relevance/1 

```{r load-libraries}
PKG <- c("devtools", "googledrive", "ggplot2", 
         "magrittr", "here", "dplyr", "sf", "readxl", 
         "janitor")
for (p in PKG) {
  if(!require(p,character.only = TRUE)) {  
    install.packages(p, verbose = FALSE)
    require(p,character.only = TRUE)}
}
```


```{r load-data}

# SIGN INTO GOOGLE DRIVE--------------------------------------------------------
googledrive_dl <- TRUE
googledrive::drive_deauth()
googledrive::drive_auth()
2

# Download google spreadsheet --------------------------------------------------
googledrive_dl <- "https://docs.google.com/spreadsheets/d/1l6a9Wb3M1PQV9UwHk7Ddfiiuq5U5lVW5"

googledrive::drive_download(file = googledrive::as_id(googledrive_dl),  #"gap_survey_progression.csv",
                            # type = "xlsx", 
                            overwrite = TRUE, 
                            path = here::here("data/data.xlsx"))

dat <- readxl::read_xlsx(path = here::here("data/data.xlsx"), sheet = "Papers") %>% 
  janitor::clean_names() 
```

figure_printure base (just for making following plots consistent)

```{r figure_printure-base}
figure_base <- ggplot2::ggplot()  +
  theme_bw()  +
  ggplot2::theme(
    panel.border = element_rect(colour = "grey50", fill=NA, linewidth=.5),
    plot.margin=unit(c(0,0,0,0), "cm") ,
    panel.background = element_rect(fill = "white"), #grey95
    legend.position="bottom",
    legend.direction="horizontal",
    legend.justification="left",
    legend.background = element_blank(),
    legend.location = "right", 
    legend.box.background = element_blank())
```


```{r auto-plot-fnct}
auto_plot <- function(dat1, column0, other_cutoff = 20, title0 = "") {
  
  dat0 <- dat1  %>% 
    dplyr::rename(column = any_of(column0)) 
  
  dat0 <- dat0 %>% 
    dplyr::left_join(dat0 %>% 
                       dplyr::group_by(column) %>% 
                       dplyr::summarise(freq = n()) %>% 
                       dplyr::ungroup() %>%
                       dplyr::arrange(desc(freq)) %>%
                       dplyr::mutate(names0 = ifelse(freq <= other_cutoff, "Other", column)) ) %>% 
    dplyr::group_by(publication_year, names0) %>% 
    dplyr::summarise(freq = n()) %>% 
    dplyr::ungroup() %>%
    dplyr::arrange(desc(freq))
  
  
  figure_print <- figure_base + 
    ggplot2::geom_line(
      data = dat0, 
      # show.legend = FALSE, 
      mapping = aes(x = publication_year, 
                    y = freq, 
                    color = names0)) + 
    ggplot2::scale_color_viridis_d(name = "", option = "mako", begin = .1, end = .7) + 
    xlab("Year") +
    ylab("Frequency") +
    ggtitle(title0) 
  
  return(figure_print)
}
```

Plot of freq and year, by research field

```{r}
column0 = "research_field"
figure_print <- auto_plot(dat1 = dat, 
                 column0 = column0, 
                 other_cutoff = 20, 
                 title0 = "Plot of freqency and year, by research field")

  ggsave(filename = here::here("output", paste0("figure_print-",column0,".png")),
         plot = figure_print, width = 6, height = 6)
  figure_print
```

Plot of freq and year, by gear type

```{r}
column0 = "gear_type"
figure_print <- auto_plot(dat1 = dat, 
                 column0 = column0, 
                 other_cutoff = 20, 
                 title0 = "Plot of freqency and year, by location")

  ggsave(filename = here::here("output", paste0("figure_print-",column0,".png")),
         plot = figure_print, width = 6, height = 6)
  figure_print
```

Plot of freq and year, by region

```{r}

column0 = "location"
figure_print <- auto_plot(dat1 = dat, 
                 column0 = column0, 
                 other_cutoff = 20, 
                 title0 = "Plot of freqency and year, by location")

  ggsave(filename = here::here("output", paste0("figure_print-",column0,".png")),
         plot = figure_print, width = 6, height = 6)
  figure_print
```

Plot of freq and year, by journal

```{r}
# which publications have less than X (10?) hits over the whole timeseries?
column0 = "source_title"
figure_print <- auto_plot(dat1 = dat, 
                 column0 = column0, 
                 other_cutoff = 20, 
                 title0 = "Plot of freqency and year, by journal")

  ggsave(filename = here::here("output", paste0("figure_print-",column0,".png")),
         plot = figure_print, width = 6, height = 6)
  figure_print
```

Plot of freq and year, by affiliation

```{r}
dat_aff <- dat %>% 
  dplyr::select(affiliations, publication_year) %>%
  tidyr::separate(col = "affiliations", sep = "; ", remove = FALSE, into = paste0("aff_", 1:30)) %>% 
  dplyr::select(-affiliations) %>%
  tidyr::pivot_longer(cols = paste0("aff_", 1:30), names_to = "aff_var", values_to = "aff_val") %>%
  dplyr::select(-aff_var) %>% 
  dplyr::filter(!is.na(aff_val))
  # dplyr::group_by(publication_year, aff_val) %>% 
  # dplyr::summarise(freq = n()) %>% 
  # dplyr::filter(!is.na(freq))

column0 = "aff_val"
figure_print <- auto_plot(dat1 = dat_aff, 
                 column0 = column0, 
                 other_cutoff = 20, 
                 title0 = "Plot of freq and year, by affiliation")

  ggsave(filename = here::here("output", paste0("figure_print-",column0,".png")),
         plot = figure_print, width = 6, height = 6)
  figure_print
```

Plot of freq and year, by government, academic, and industry affiliated coauthor

```{r}
dat_aff <- dat_aff %>% 
  dplyr::mutate(aff_val1 = dplyr::case_when(
    grepl(x = aff_val, pattern = "NOAA") ~ "NOAA",
    grepl(x = aff_val, pattern = "National Oceanic and Atmospheric Administration") ~ "NOAA"
  ))

column0 = "aff_val1"
figure_print <- auto_plot(dat1 = dat_aff, 
                 column0 = column0, 
                 other_cutoff = 20, 
                 title0 = "Plot of freq and year, by affiliation")

  ggsave(filename = here::here("output", paste0("figure_print-",column0,".png")),
         plot = figure_print, width = 6, height = 6)
  figure_print
```

Plot of freq and year, by key words

> need to find a way to group similar topics

```{r}
dat_key <- dat %>% 
  dplyr::select(author_keywords, publication_year) %>%
  tidyr::separate(col = "author_keywords", sep = "; ", remove = FALSE, into = paste0("key_", 1:10)) %>% 
  dplyr::select(-author_keywords) %>%
  tidyr::pivot_longer(cols = paste0("key_", 1:10), names_to = "key_var", values_to = "key_val") %>%
  dplyr::select(-key_var) %>% 
  dplyr::filter(!is.na(key_val)) %>% 
  dplyr::mutate(key_val = tolower(key_val), 
               key_val = gsub(x = key_val, pattern = "-", replacement = " ") , 
               key_val1 = dplyr::case_when(
                 key_val == "fisheries" ~ "fisheries (and simlar)",
                 key_val == "fishery" ~ "fisheries (and simlar)", 
                 grepl(x = key_val, pattern = "coral") ~ "coral (and similar)", 
                 grepl(x = key_val, pattern = "covid") ~ "covid (and similar)"
                 # key_val == "fisheries" ~ "fisheries (and simlar)"
                 # key_val == "fisheries" ~ "fisheries (and simlar)"
               )
               ) %>% 
  dplyr::arrange(key_val)

sort(unique(dat_key$key_val))
sort(unique(dat_key$key_val1))

column0 = "key_val"
figure_print <- auto_plot(dat1 = dat_key, 
                 column0 = column0, 
                 other_cutoff = 10, 
                 title0 = "Plot of freq and year, by key word")

  ggsave(filename = here::here("output", paste0("figure_print-",column0,".png")),
         plot = figure_print, width = 6, height = 6)
  figure_print
```
keyword cloud

```{r, eval = FALSE}
# https://cran.r-project.org/web/packages/ggwordcloud/vignettes/ggwordcloud.html
# install.packages("ggwordcloud")
library("ggwordcloud")

dat_key <- dat %>% 
  dplyr::select(author_keywords, publication_year) %>%
  tidyr::separate(col = "author_keywords", sep = "; ", remove = FALSE, into = paste0("key_", 1:10)) %>% 
  dplyr::select(-author_keywords) %>%
  tidyr::pivot_longer(cols = paste0("key_", 1:10), names_to = "key_var", values_to = "key_val") %>%
  dplyr::select(-key_var) %>% 
  dplyr::filter(!is.na(key_val))

figure_print <- figure_base + 
  ggwordcloud::geom_text_wordcloud(data = dat_key, 
                       mapping = aes(label = key_val)) +
  scale_size_area(max_size = 30) +
  theme_minimal()

column0 = "key"
  ggsave(filename = here::here("output", paste0("figure_print-",column0,".png")),
         plot = figure_print, width = 6, height = 6)
  figure_print
```
